# 番茄 - TXT 阅读器集成需求文档

## 项目概述

将"番茄工作法计时器"升级为"番茄"，集成在线 TXT 阅读器功能，专为 iPad 设计。

## 核心功能

### 1. 项目重命名
- 应用名称：TomatoTimer → 番茄 (Tomato)
- Bundle ID 保持不变（避免重新签名问题）
- 显示名称改为"番茄"

### 2. WebDAV 文件源

#### 2.1 账号管理
- 保存 WebDAV 服务器地址、用户名、密码
- 密码存储在 iOS Keychain（安全）
- 支持多个 WebDAV 账号配置
- 测试连接功能

#### 2.2 文件浏览
- 树形目录浏览（文件夹/文件列表）
- 仅显示 .txt 文件
- 显示文件大小、修改时间
- 支持搜索文件名

#### 2.3 在线打开
- 点击文件直接在线打开（流式读取）
- 分块加载（每次 1-2MB）
- 不自动下载完整文件
- 支持大文件（100MB+）

#### 2.4 本地导入（可选）
- 从"文件"App 打开 .txt 文件
- 不提供批量下载功能
- 不提供缓存管理

### 3. 编码识别与防乱码

#### 3.1 自动识别编码
支持以下编码：
- UTF-8（含 BOM）
- UTF-16 LE/BE（含 BOM）
- GB18030 / GBK
- Big5
- Shift-JIS
- ISO-8859-1 / Windows-1252
- KOI8-R
- EUC-KR

#### 3.2 编码选择器
- 自动识别失败时弹出
- 实时预览前 3-5 行
- 一键重新解码
- 记住每本书的编码选择（持久化）

#### 3.3 文本处理
- 统一换行符（\r\n → \n）
- 内部统一使用 UTF-8
- 仅在内存中转换，不修改原文件

### 4. 阅读体验

#### 4.1 显示模式
- **分页模式**（默认，省电）
  - 左右滑动翻页
  - 显示页码
- **滚动模式**
  - 连续滚动
  - 滚动条

#### 4.2 排版设置
- 字体选择（系统字体 + 自定义）
- 字号调节（12-36pt）
- 行距调节（1.0-2.5x）
- 页边距调节（10-50pt）
- 段落间距

#### 4.3 主题
- 白天模式（白底黑字）
- 夜间模式（黑底白字）
- 护眼模式（米黄底深灰字）
- 跟随系统外观

#### 4.4 目录与导航
- 自动识别章节（正则匹配）
  - "第X章"、"第X卷"、"第X节"、"第X回"
  - "Chapter X"、"Part X"
- 目录列表（点击跳转）
- 进度条（拖动跳转）
- 百分比显示
- 预计剩余阅读时长（基于阅读速度）

#### 4.5 搜索功能
- 全文搜索
- 先搜索当前章节，再搜索全书
- 高亮显示结果
- 上一个/下一个结果

#### 4.6 标注与书签
- 文本高亮（多种颜色）
- 添加书签（快速跳转）
- 添加笔记（文字备注）
- 数据保存在本地（不跨设备同步）

### 5. iPad 特性

#### 5.1 多任务
- 支持分屏（Split View）
- 支持滑动覆盖（Slide Over）
- 画中画（可选）

#### 5.2 外接键盘快捷键
- `空格` / `↓` - 下一页
- `↑` - 上一页
- `←` / `→` - 上一章/下一章
- `Cmd+F` - 搜索
- `Cmd+B` - 添加书签
- `Cmd+T` - 目录
- `Cmd+,` - 设置

#### 5.3 Apple Pencil（可选）
- 手写批注
- 划线标注
- 涂鸦笔记

### 6. 辅助功能

#### 6.1 系统 TTS 朗读
- 调用系统语音合成
- 播放/暂停/停止
- 语速调节
- 语音选择（中文/英文等）

#### 6.2 VoiceOver
- 完整 VoiceOver 支持
- 语义化标签

#### 6.3 动态字体
- 支持系统动态字体大小

#### 6.4 词典/翻译（可选）
- 长按选词
- 系统词典查询
- 翻译功能

## 技术架构

### 数据层
- **WebDAVManager**：WebDAV 连接、文件列表、下载
- **EncodingDetector**：编码自动识别
- **TextDecoder**：文本解码与转换
- **BookStore**：书籍元数据、阅读进度、书签笔记

### 业务层
- **ReaderEngine**：分页/滚动逻辑、章节解析
- **SearchEngine**：全文搜索
- **TTSManager**：语音朗读

### 视图层
- **WebDAVView**：WebDAV 配置与文件浏览
- **ReaderView**：阅读主界面
- **TableOfContentsView**：目录
- **SettingsView**：阅读设置
- **AnnotationView**：标注与笔记

## 数据存储

### UserDefaults
- WebDAV 服务器地址
- 阅读设置（字体、字号、主题等）
- 最近打开的文件

### Keychain
- WebDAV 密码

### CoreData / JSON
- 书籍列表
- 阅读进度
- 书签与笔记
- 编码记忆

## UI/UX 设计

### 导航结构
```
TabView
├── 计时器（原功能）
├── 阅读器（新功能）
│   ├── 文件源选择（WebDAV / 本地）
│   ├── 文件浏览
│   └── 阅读界面
├── 宠物（原功能）
├── 成就（原功能）
└── 设置
```

### 阅读界面布局
```
┌─────────────────────────────┐
│ [返回] 书名        [目录][设置] │
├─────────────────────────────┤
│                             │
│                             │
│        文本内容区域          │
│                             │
│                             │
├─────────────────────────────┤
│ ━━━━━━━━━━━━━━━━━━━━━━━━━ │
│ 第3章 | 45% | 剩余30分钟      │
└─────────────────────────────┘
```

## 实施计划

### Phase 1：基础架构（1-2天）
- [x] 项目重命名
- [ ] WebDAV 基础连接
- [ ] 编码识别核心逻辑
- [ ] 基础阅读视图

### Phase 2：核心功能（2-3天）
- [ ] 文件浏览与在线打开
- [ ] 分页/滚动模式
- [ ] 排版设置
- [ ] 主题切换

### Phase 3：高级功能（2-3天）
- [ ] 自动目录识别
- [ ] 全文搜索
- [ ] 书签与笔记
- [ ] TTS 朗读

### Phase 4：iPad 优化（1-2天）
- [ ] 分屏支持
- [ ] 键盘快捷键
- [ ] Apple Pencil（可选）

### Phase 5：测试与优化（1-2天）
- [ ] 大文件测试
- [ ] 各种编码测试
- [ ] 性能优化
- [ ] 辅助功能测试

## 注意事项

1. **性能优化**：大文件分块加载，避免内存溢出
2. **编码兼容**：测试各种编码的 TXT 文件
3. **网络处理**：WebDAV 连接失败、超时处理
4. **数据安全**：密码加密存储，不明文保存
5. **用户体验**：流畅的翻页动画，快速响应
6. **向后兼容**：保留原有番茄钟功能，不影响现有用户

## 测试用例

### 编码测试
- UTF-8（无 BOM）
- UTF-8（有 BOM）
- GBK（简体中文）
- Big5（繁体中文）
- Shift-JIS（日文）
- 混合编码文件

### 文件大小测试
- 小文件（< 1MB）
- 中等文件（1-10MB）
- 大文件（10-100MB）
- 超大文件（> 100MB）

### WebDAV 测试
- 坚果云
- Nextcloud
- ownCloud
- Synology NAS

## 参考资源

- [WebDAV RFC 4918](https://tools.ietf.org/html/rfc4918)
- [Character Encoding Detection](https://github.com/saintfish/chardet)
- [AVSpeechSynthesizer](https://developer.apple.com/documentation/avfoundation/avspeechsynthesizer)
