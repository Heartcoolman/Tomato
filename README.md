# 🍅 番茄

极简的番茄工作法计时器，专为 iPadOS 26+ 设计。

## ✨ 功能特性

### 📚 TXT 阅读器（NEW！）

#### WebDAV 云端阅读
- **账号管理**：支持多个 WebDAV 账号（坚果云、Nextcloud 等）
- **密码安全**：密码存储在 iOS Keychain，安全可靠
- **在线浏览**：树形目录浏览，支持文件搜索
- **流式读取**：点击即读，无需下载完整文件
- **大文件支持**：分块加载，支持 100MB+ 大文件

#### 智能编码识别
- **自动检测**：UTF-8、UTF-16、GB18030/GBK、Big5、Shift-JIS、ISO-8859-1、KOI8-R、EUC-KR 等
- **编码选择器**：自动识别失败时弹出，实时预览前 3-5 行
- **记忆功能**：记住每本书的编码选择
- **防乱码**：统一换行符，内部 UTF-8 处理

#### 流畅阅读体验
- **双模式**：分页模式（省电）/ 滚动模式
- **自定义排版**：字体、字号（12-36pt）、行距、页边距
- **三种主题**：白天 / 夜间 / 护眼，支持跟随系统
- **智能目录**：自动识别章节（第X章/卷/节/回）
- **阅读进度**：进度条、百分比、预计剩余时长
- **全文搜索**：先章内后全书，高亮显示结果
- **标注书签**：高亮、书签、笔记（本地存储）

#### iPad 特性
- **分屏支持**：Split View、Slide Over
- **键盘快捷键**：空格翻页、Cmd+F 搜索、Cmd+B 书签等
- **Apple Pencil**：手写批注、划线标注（可选）
- **系统 TTS**：语音朗读，可调语速
- **辅助功能**：VoiceOver、动态字体、词典翻译

### ⏱️ 番茄工作法

#### 核心功能
- **三段模式**：工作（25分钟）、短休息（5分钟）、长休息（15分钟）
- **精准计时**：采用目标结束时间 + 单调时钟策略，避免后台/休眠导致的计时漂移
- **智能切换**：每完成 4 个工作番茄自动进入长休息
- **灵活控制**：开始/暂停、重置、+5分钟、跳过

### 提醒系统
- **本地通知**：前台/后台均可收到完成提醒
- **蜂鸣音效**：可选系统声音提示
- **触觉反馈**：操作和完成时的震动反馈

### 电源管理
- **保持常亮**：计时时可选禁用自动锁屏
- **多窗口支持**：仅一个活动计时器，其他窗口只读跟随

### 数据统计
- **今日统计**：完成番茄数、总分钟数
- **周统计**：本周汇总数据
- **连续天数**：Streak 记录
- **CSV 导出**：一键导出历史数据

### 🎮 游戏化激励系统（NEW！）

#### 番茄币系统 💰
- **自动奖励**：完成番茄钟获得番茄币（工作+10币，休息+3/5币）
- **交易记录**：完整的收入支出历史
- **动画效果**：金币飞入动画，视觉反馈

#### 虚拟宠物养成 🐱
- **4种宠物**：番茄猫🐱、番茄狗🐶、番茄鸟🐦、番茄兔🐰
- **100级成长**：从1级养到100级，经验升级系统
- **4个进化阶段**：幼年 → 少年 → 青年 → 成年
- **自动状态系统**：饥饿度、快乐度、健康度、精力值实时变化
- **互动玩法**：喂食(-15币)、玩耍(-10币)、抚摸(免费)、治疗(-50币)
- **6个技能加成**：
  - Lv.5：番茄币奖励+10%
  - Lv.15：自动恢复精力
  - Lv.30：饥饿度下降速度-50%
  - Lv.50：完成时庆祝动画
  - Lv.70：番茄币奖励+20%
  - Lv.80：解锁专属游戏
- **精美动画**：呼吸、跳跃、摇晃等宠物动画

#### 成就系统 🏆
- **20+个成就**：涵盖番茄钟完成、打卡天数、工作时长、宠物等级等
- **5个等级**：青铜 → 白银 → 金 → 铂金 → 钻石
- **自动解锁**：完成条件时自动触发，烟花动画庆祝
- **进度追踪**：实时显示解锁进度百分比
- **额外奖励**：解锁成就获得番茄币奖励

#### 迷你游戏 🎮
- **番茄接水果**：60秒限时，拖动篮子接番茄避开炸弹
- **2048番茄版**：经典2048玩法，精美方块设计
- **记忆翻牌**：8对卡片配对，90秒限时挑战
- **每日限制**：每个游戏每天限玩5次，防止刷币
- **高分记录**：保存个人最高分
- **番茄币奖励**：根据得分获得番茄币（得分÷10等）

### 可访问性
- ✅ VoiceOver 支持
- ✅ Dynamic Type（动态字体）
- ✅ Reduce Motion（减弱动画）
- ✅ WCAG AA 对比度标准

### 键盘快捷键
- `空格` - 开始/暂停
- `R` - 重置
- `1/2/3` - 切换到工作/短休息/长休息
- `N` - 跳到下一段
- `↑/↓` - 当前模式时长 ±1 分钟

## 🎨 设计

- **主色**：#B52B2D（番茄红）
- **背景**：#F9F9F5（淡黄）
- **文字**：#2B2B2B（深灰）
- **风格**：极简、大量留白、无花哨动效

## 🛠️ 技术栈

- **平台**：iPadOS 26.0+
- **框架**：SwiftUI、Combine
- **功能**：
  - UserNotifications（通知）
  - AVFoundation（音频、TTS）
  - UIKit（触觉反馈）
  - Security（Keychain 密码存储）
  - Foundation（WebDAV、编码检测）
- **架构**：MVVM + Actor 并发
- **测试**：XCTest
- **CI/CD**：GitHub Actions

## 📦 构建与安装

### 前置要求

1. **GitHub 账号**（用于构建）
2. **Apple 开发者账号**（免费或付费，用于签名）
3. **签名工具**（选择一种）：
   - **Sideloadly**（推荐，最简单）
   - **AltStore**
   - **Xcode**（如有 Mac）

### 快速开始（3 步）

#### 步骤 1：GitHub 自动构建

1. 推送代码到 GitHub（或手动触发 Actions）
2. 等待 10-15 分钟自动构建
3. ✅ **无需配置任何 Apple 凭证！**

#### 步骤 2：下载未签名 IPA

1. 在 **Actions** 页面找到最新的成功构建
2. 滚动到底部 **Artifacts** 区域
3. 下载 **TomatoTimer-Unsigned-IPA**
4. 解压得到 `TomatoTimer-unsigned.ipa`

#### 步骤 3：自签名并安装

使用 **Sideloadly**（推荐）：

1. 下载 [Sideloadly](https://sideloadly.io/)（支持 Windows/Mac）
2. iPad 通过 USB 连接电脑
3. 将 `TomatoTimer-unsigned.ipa` 拖入 Sideloadly
4. 输入您的 Apple ID 和密码
5. 点击 **Start**，等待签名并自动安装
6. iPad 信任证书（设置 → 通用 → VPN 与设备管理）

**详细签名指南**：查看 [SELF_SIGNING_GUIDE.md](SELF_SIGNING_GUIDE.md)，包含多种签名方式。

### ⚠️ 免费账号限制

使用免费 Apple 开发者账号有以下限制：

1. **7 天有效期**：应用签名 7 天后过期，需重新签名
2. **设备限制**：每个 Apple ID 最多 3 台设备
3. **通知受限**：本地通知可能无法正常工作（需付费账号）

**自动刷新**：Sideloadly 和 AltStore 都支持自动刷新，保持电脑运行即可。

## 🧪 测试

运行单元测试：

```bash
xcodebuild test \
  -project TomatoTimer.xcodeproj \
  -scheme TomatoTimer \
  -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)'
```

## 📝 使用说明

### 📚 阅读器使用

#### 添加 WebDAV 账号
1. 切换到"阅读"标签页
2. 点击"添加账号"按钮
3. 填写账号信息：
   - 账号名称（自定义）
   - 服务器地址（如：https://dav.jianguoyun.com/dav/）
   - 用户名
   - 密码
4. 点击"测试连接"验证
5. 保存账号

#### 浏览和打开文件
1. 选择已添加的 WebDAV 账号
2. 浏览文件夹，点击进入子目录
3. 使用搜索框快速查找文件
4. 点击 .txt 文件即可在线打开
5. 自动识别编码，如失败会弹出编码选择器
6. 选择正确编码后开始阅读

#### 阅读操作
- **翻页**：左右滑动（分页模式）或上下滚动（滚动模式）
- **目录**：点击顶部目录图标查看章节
- **设置**：点击顶部设置图标调整字体、主题等
- **进度**：底部显示当前章节、百分比、页码
- **书签**：长按文本添加书签或高亮

#### 阅读设置
1. 点击阅读界面右上角设置图标
2. 可调整：
   - 显示模式（分页/滚动）
   - 字号（12-36pt）
   - 行距（1.0-2.5x）
   - 页边距
   - 主题（白天/夜间/护眼）
3. 实时预览效果
4. 保存设置

### ⏱️ 番茄钟使用

#### 基本使用

1. **选择模式**：顶部分段控制器选择工作/短休息/长休息
2. **开始计时**：点击"开始"按钮或按空格键
3. **暂停**：点击"暂停"或再次按空格键
4. **重置**：点击"重置"按钮或按 `R` 键
5. **完成**：计时结束后会收到通知、声音和触觉反馈

### 高级功能

- **+5 分钟**：临时延长当前计时
- **跳过**：完成当前阶段并切换到下一个
- **自动切换**：在设置中开启后，完成时自动进入下一阶段
- **保持常亮**：计时时保持屏幕不锁定

### 查看统计

1. 切换到"历史"页面
2. 查看今日、本周的番茄数和时长
3. 查看连续天数（Streak）
4. 点击"导出"按钮导出 CSV 数据

### 自定义设置

1. 切换到"设置"页面
2. 调整各模式的时长（1-60 分钟）
3. 开关通知、声音、触觉、自动切换等功能

### 🎮 游戏化功能使用

#### 领养宠物
1. 切换到"宠物"页面
2. 点击"领养宠物"按钮
3. 选择宠物类型（猫/狗/鸟/兔）
4. 输入宠物名字
5. 确认领养，开始养成之旅

#### 宠物互动
- **喂食**：花费15番茄币，降低饥饿度30%，增加快乐度5%
- **玩耍**：花费10番茄币，增加快乐度15%，消耗精力10%
- **抚摸**：免费，增加快乐度3%（5分钟冷却）
- **治疗**：花费50番茄币，恢复健康度50%（生病时使用）

#### 查看成就
1. 切换到"成就"页面
2. 查看已解锁和未解锁的成就
3. 点击成就卡片查看详细信息和解锁进度
4. 筛选显示（全部/已解锁/未解锁）

#### 玩迷你游戏
1. 在计时器页面点击游戏手柄图标（休息时可玩）
2. 选择想玩的游戏
3. 每个游戏每天限玩5次
4. 根据得分获得番茄币奖励

## 🐛 已知问题

- 免费开发者账号的本地通知可能受限
- 7 天签名有效期需要定期刷新

## 📄 许可证

MIT License

## 🎯 游戏化系统特色

- **长期动力**：通过宠物养成和成就解锁，保持长期使用热情
- **即时反馈**：每次完成都有番茄币、经验、升级等多重奖励
- **防止作弊**：跳过不给奖励，游戏每日限玩，确保公平性
- **完整养成**：从0级到100级的完整成长体系
- **趣味互动**：休息时玩小游戏，工作时养宠物，劳逸结合

## 🌟 阅读器特色

### 为什么选择番茄阅读器？

1. **真正的在线阅读**：无需下载完整文件，点击即读，节省空间
2. **智能编码识别**：自动识别 10+ 种编码，告别乱码困扰
3. **云端同步**：WebDAV 连接，多设备访问同一书库
4. **安全可靠**：密码存储在 iOS Keychain，不会泄露
5. **专为 iPad 优化**：分屏、键盘、Apple Pencil 全支持
6. **完全免费**：无广告、无内购、开源

### 支持的 WebDAV 服务

- ✅ 坚果云（推荐，国内速度快）
- ✅ Nextcloud（开源自建）
- ✅ ownCloud
- ✅ Synology NAS
- ✅ QNAP NAS
- ✅ 其他标准 WebDAV 服务

### 支持的文本编码

- UTF-8（含 BOM）
- UTF-16 LE/BE（含 BOM）
- GB18030 / GBK（简体中文）
- Big5（繁体中文）
- Shift-JIS（日文）
- ISO-8859-1 / Windows-1252（西欧）
- KOI8-R（俄文）
- EUC-KR（韩文）

## 🙏 致谢

- 采用番茄工作法（Pomodoro Technique）提升工作效率
- 游戏化设计灵感来自各类养成游戏
- 感谢 Codex Review 发现并帮助修复多个关键 Bug

## 📚 相关文档

### 阅读器文档
- [QUICK_START_READER.md](QUICK_START_READER.md) - 📖 阅读器 5 分钟快速上手指南（推荐新手）
- [READER_IMPLEMENTATION.md](READER_IMPLEMENTATION.md) - TXT 阅读器技术实现文档

### 番茄钟文档
- [GAMIFICATION_IMPLEMENTATION.md](GAMIFICATION_IMPLEMENTATION.md) - 游戏化系统完整实现文档

### 安装文档
- [SELF_SIGNING_GUIDE.md](SELF_SIGNING_GUIDE.md) - 自签名安装指南
- [FREE_ACCOUNT_GUIDE.md](FREE_ACCOUNT_GUIDE.md) - 免费账号使用指南

## 🔮 未来计划

### 阅读器增强
- [ ] 完善分页算法
- [ ] 书签和高亮功能
- [ ] 全文搜索
- [ ] TTS 语音朗读
- [ ] 词典/翻译集成
- [ ] Apple Pencil 批注
- [ ] 阅读统计

### 番茄钟增强
- [ ] 白噪音播放
- [ ] 专注模式（屏蔽通知）
- [ ] 番茄钟与阅读器联动
- [ ] 更多迷你游戏

---

**祝您高效工作，快乐阅读，开心养宠！** 🍅📚🐱

