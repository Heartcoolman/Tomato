# WebDAV 连接测试指南

## 快速测试步骤

### 准备工作

1. **编译并运行 App**
   ```bash
   open TomatoTimer.xcodeproj
   # 在 Xcode 中选择模拟器或真机，点击 Run (Cmd+R)
   ```

2. **准备测试账号**（选择一个）
   - **坚果云**（推荐）- 需要应用密码
   - **Nextcloud** - 需要服务器地址和账号
   - **自建 WebDAV** - 需要服务器配置

### 测试步骤

#### 步骤 1: 添加 WebDAV 账号

1. 打开 App
2. 点击底部"阅读"标签
3. 点击右上角"+"按钮
4. 填写账号信息

**坚果云示例**:
```
账号名称: 测试账号
服务器地址: https://dav.jianguoyun.com/dav/
用户名: your-email@example.com
密码: [应用密码，不是登录密码]
```

5. 点击"测试连接"按钮

**预期结果**: 
- ✅ 应显示"连接成功"
- ✅ 无错误提示

**如果失败**: 查看 [WEBDAV_TROUBLESHOOTING.md](WEBDAV_TROUBLESHOOTING.md)

#### 步骤 2: 浏览文件列表

1. 保存账号后，点击账号卡片
2. 应该看到文件列表加载中...
3. 等待 1-3 秒

**预期结果**:
- ✅ 显示根目录的文件和文件夹列表
- ✅ 文件夹显示蓝色文件夹图标
- ✅ .txt 文件显示灰色文档图标
- ✅ 显示文件大小和修改日期

**测试检查点**:
- [ ] 能看到文件夹吗？
- [ ] 能看到 .txt 文件吗？
- [ ] 文件大小显示正确吗？
- [ ] 日期显示正确吗？

#### 步骤 3: 浏览子目录

1. 点击任意文件夹
2. 应进入子目录

**预期结果**:
- ✅ 导航标题更新为当前目录名
- ✅ 显示子目录的文件列表
- ✅ 顶部有"返回上级"按钮

**测试检查点**:
- [ ] 能进入子目录吗？
- [ ] 能返回上级目录吗？
- [ ] 多层嵌套目录正常吗？

#### 步骤 4: 搜索文件

1. 在搜索框输入文件名（如"test"）
2. 观察列表过滤

**预期结果**:
- ✅ 实时过滤显示匹配的文件
- ✅ 支持中文搜索
- ✅ 不区分大小写

#### 步骤 5: 下载和打开文件

1. 点击任意 .txt 文件
2. 等待文件下载

**预期结果**:
- ✅ 显示加载指示器
- ✅ 如果编码自动识别成功，直接打开阅读
- ✅ 如果编码识别失败，弹出编码选择器

**测试文件**:
- UTF-8 文件（应自动识别）
- GBK/GB18030 中文文件（可能需要手动选择）
- Big5 繁体中文文件（可能需要手动选择）

## 问题排查

### 问题 1: 看不到文件列表

**检查**:
- 确认 WebDAV 服务器中确实有文件
- 确认文件扩展名是 `.txt`（小写）
- 查看 Xcode 控制台是否有错误日志

**调试输出**:
在 Xcode 控制台中查找类似输出：
```
🔍 请求 URL: https://dav.jianguoyun.com/dav/
📊 响应状态码: 207
📄 响应数据大小: 1234 bytes
📦 解析到 5 个项目
  - 我的小说 [文件夹]
  - test.txt [文件]
```

### 问题 2: 文件名乱码

**原因**: 服务器可能返回了非 UTF-8 编码的路径

**解决**: 确保文件名使用 UTF-8 编码，或联系开发者添加其他编码支持

### 问题 3: 下载失败

**检查**:
- 文件是否太大（> 100MB）
- 网络连接是否稳定
- 查看错误提示信息

## 测试场景清单

### 基本功能测试

- [ ] 添加 WebDAV 账号
- [ ] 测试连接
- [ ] 查看根目录文件列表
- [ ] 进入子目录
- [ ] 返回上级目录
- [ ] 搜索文件
- [ ] 下载并打开 .txt 文件

### 边界情况测试

- [ ] 空文件夹（应显示空列表）
- [ ] 只有文件夹的目录
- [ ] 只有文件的目录
- [ ] 文件名包含特殊字符（空格、中文、符号）
- [ ] 深层嵌套目录（5 层以上）
- [ ] 大文件（> 10MB）
- [ ] 小文件（< 1KB）

### 错误处理测试

- [ ] 错误的服务器地址
- [ ] 错误的用户名或密码
- [ ] 网络断开时的表现
- [ ] 服务器超时
- [ ] 文件下载中途失败

### 多账号测试

- [ ] 添加多个 WebDAV 账号
- [ ] 切换账号
- [ ] 删除账号
- [ ] 不同服务器类型（坚果云 + Nextcloud）

## 性能测试

### 大列表性能

测试目录包含：
- 100 个文件
- 50 个文件夹
- 总共 150 项

**预期**:
- 加载时间 < 3 秒
- 滚动流畅，无卡顿
- 搜索响应及时

### 大文件下载

测试文件大小：
- 1MB - 应快速下载
- 10MB - 应在 10 秒内完成
- 50MB - 可能需要 30-60 秒

## 兼容性测试

### 服务器类型

- [ ] 坚果云 (https://dav.jianguoyun.com/dav/)
- [ ] Nextcloud (https://server/remote.php/dav/files/user/)
- [ ] ownCloud
- [ ] Synology NAS
- [ ] QNAP NAS
- [ ] Apache mod_dav

### 编码测试

创建以下测试文件：
- `utf8-test.txt` - UTF-8 编码
- `gbk-test.txt` - GBK 编码（简体中文）
- `big5-test.txt` - Big5 编码（繁体中文）
- `sjis-test.txt` - Shift-JIS 编码（日文）

## 测试报告模板

### 环境信息

```
iOS 版本: iOS 26.0.1
设备型号: iPad Pro 13-inch (M4)
App 版本: v1.1
测试日期: 2025-10-22
```

### WebDAV 服务器信息

```
类型: 坚果云 / Nextcloud / 其他
服务器地址: https://...
测试文件数量: 
```

### 测试结果

| 功能 | 状态 | 备注 |
|------|------|------|
| 连接测试 | ✅ / ❌ | |
| 文件列表 | ✅ / ❌ | |
| 子目录浏览 | ✅ / ❌ | |
| 文件搜索 | ✅ / ❌ | |
| 文件下载 | ✅ / ❌ | |
| 编码识别 | ✅ / ❌ | |

### 发现的问题

1. **问题描述**: 
   - 重现步骤: 
   - 预期结果: 
   - 实际结果: 
   - 错误信息: 

### 建议和改进

- [ ] 功能建议 1
- [ ] 功能建议 2
- [ ] 性能优化建议

## 调试技巧

### Xcode 控制台

查看详细日志：
```
(lldb) po items
(lldb) po errorMessage
```

### 网络抓包

使用 Charles Proxy 或 Proxyman：
1. 配置 iOS 设备代理
2. 安装 HTTPS 证书
3. 过滤 WebDAV 域名
4. 观察请求和响应

### 模拟器 vs 真机

- **模拟器**: 方便调试，有控制台输出
- **真机**: 测试实际性能和网络条件

## 成功标准

本次修复成功的标准：

1. ✅ 能成功连接至少一个 WebDAV 服务器
2. ✅ 能正确显示文件和文件夹列表
3. ✅ 能浏览子目录并返回
4. ✅ 能下载并打开 .txt 文件
5. ✅ 文件名、大小、日期显示正确
6. ✅ 无崩溃或严重错误

## 下一步

测试完成后：

1. **如果成功** ✅
   - 提供测试反馈
   - 建议可以推送到 GitHub
   - 考虑发布新版本

2. **如果失败** ❌
   - 记录详细错误信息
   - 提供 WebDAV 服务器类型
   - 查看 [WEBDAV_TROUBLESHOOTING.md](WEBDAV_TROUBLESHOOTING.md)
   - 联系开发者进一步修复

---

**祝测试顺利！** 🧪✨

